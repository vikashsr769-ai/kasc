<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Faculty – Student DB Management</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --bg:#0f1111;
  --panel:#161b1b;
  --panel-soft:#232f3e;
  --border:#2e3b4e;
  --text:#ffffff;
  --muted:#b0b7bd;
  --accent:#f6ff00;
  --danger:#ff0000;
  --radius:12px;
}

*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:"Segoe UI",Arial,sans-serif;
}

body{
  background: var(--bg);
  color: var(--text);
  display: grid;
  grid-template-columns: 240px 1fr;
  min-height: 100vh;
  transition: all 0.3s ease;
}

.sidebar{
  background:#131921;
  padding:28px 20px;
  border-right:1px solid var(--border);
  display:flex;
  flex-direction:column;
  transition: transform 0.3s ease;
}

.sidebar.hide{
  transform: translateX(-100%);
}

.brand{
  font-size: clamp(18px, 2vw, 22px);
  font-weight:800;
  color:var(--accent);
  margin-bottom:40px;
}

.nav a{
  display:block;
  padding:12px 16px;
  border-radius:8px;
  color:var(--muted);
  text-decoration:none;
  font-size: clamp(14px, 1.2vw, 16px);
  margin-bottom:5px;
}

.nav a.active,
.nav a:hover{
  background: var(--panel-soft);
  color:#fff;
}

.header{
  position:sticky;
  top:0;
  background:#0f1111;
  border-bottom:1px solid var(--border);
  padding: clamp(16px, 2vw, 24px) clamp(20px, 4vw, 40px);
  display:flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: center;
}

.header h1{
  font-size: clamp(20px, 3vw, 30px);
}

#menuToggle{
  display:none;
  font-size:24px;
  background:none;
  border:none;
  color:var(--accent);
  cursor:pointer;
}

.content{
  padding: clamp(20px, 4vw, 40px);
}

.action-btn{
  background:var(--accent);
  border:none;
  color:#111;
  padding:10px 18px;
  border-radius:6px;
  font-weight:700;
  cursor:pointer;
  width: max-content;
  min-width: 120px;
  margin: 5px 0;
  font-size: clamp(14px, 1.2vw, 16px);
}

.action-btn.danger{
  background: var(--danger);
  color:#fff;
}

select{
  width:100%;
  padding:12px;
  background: var(--panel);
  border:1px solid var(--border);
  border-radius:8px;
  color:#fff;
  margin-bottom:14px;
  font-size: 14px;
}

.table-row{
  background: var(--panel);
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px 16px;
  display: grid;
  grid-template-columns:1fr 1fr auto;
  margin-bottom:10px;
  gap:8px;
}

.status-btn,#smsLinks{
  padding:6px 14px;
  border-radius:6px;
  border:none;
  font-weight:700;
  cursor:pointer;
}

.present{background:#00ff88;color:#111}
.absent{background:#ff4d4d;color:#fff}

/* Responsive styles */
@media (max-width: 2450px) {
  body{grid-template-columns:1fr;}
  .sidebar{
    position:fixed;
    top:0;
    left:0;
    height:100vh;
    z-index:1000;
    transform:translateX(-100%);
  }
  .sidebar.show{transform:translateX(0);}
  #menuToggle{display:inline-block;}
  .overlay{
    display:block;
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:#00000080;
    z-index:500;
    display:none;
  }
  .overlay.show{display:block;}
  .table-row{
    grid-template-columns:1fr;
    grid-template-rows:auto auto auto;
    padding:12px;
  }
  .table-row button.status-btn{width:400px;}
  select{font-size:14px;padding:10px;}
}

@media (max-width: 450px) {
  .content{padding:15px;}
  .action-btn{width:90%;padding:12px;}
  .header h1{font-size:20px;}
}

form #attendanceForm{width:100%; max-width:400px;}

button,select:hover {
  border:1px solid #f6ff00;}

</style>
</head>

<body>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
  <div class="brand">FACULTY•CORE</div>
  <nav class="nav">
    <a class="active" href="#">Student Attendance</a>
    <a href="student-db.html">Student DB Management</a>
  </nav>
</aside>

<!-- Overlay for mobile -->
<div class="overlay" id="overlay"></div>

<div class="main">
  <div class="header">
    <button id="menuToggle">☰</button>
    <h1>Student Attendance</h1>
    <button class="action-btn danger" onclick="logout()">Logout</button>
  </div>

  <div class="content">

    <button class="action-btn" onclick="toggleAttendance()">+ Create New Attendance</button>

    <form id="attendanceForm" style="display:none;margin-top:20px;">
      <select id="dept" required>
        <option value="">Select Department</option>
        <option>Department of Computer Science (SF)</option>
        <option>Department of Tamil (SF)</option>
      </select>

      <select id="cls" required>
        <option value="">Select Class</option>
        <option>UG I Year</option>
        <option>UG II Year</option>
        <option>UG III Year</option>
        <option>PG I Year</option>
        <option>PG II Year</option>
      </select>

      <select id="sec" required>
        <option value="">Select Section</option>
        <option>Main</option>
        <option>Additional</option>
      </select>

      <button class="action-btn" type="submit">Load Students</button>
    </form>

    <div id="studentList" style="margin-top:30px;"></div>
<div id="smsLinks" style="margin-top:20px;"></div>
<br>    
    <button id="saveBtn" class="action-btn" style="display:none;margin-top:20px;" onclick="saveAttendance()">
      Save Attendance
    </button><br>


    

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
const supabaseclient = supabase.createClient(
  "https://fwqcfitjxcopbbedsyzd.supabase.co",
  "sb_publishable_P1WXJHSWf59fCNC7eN8w7g_5pfoF3V7"
);

const facultyEmailFromSession = sessionStorage.getItem('Email') || '';
let attendanceData = [];
var FacultyEmail = facultyEmailFromSession;

function toggleAttendance(){
  const form = document.getElementById("attendanceForm");
  form.style.display = 'block';
}

// Sidebar toggle for mobile
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');
document.getElementById('menuToggle').addEventListener('click', ()=>{
  sidebar.classList.add('show');
  overlay.classList.add('show');
});
overlay.addEventListener('click', ()=>{
  sidebar.classList.remove('show');
  overlay.classList.remove('show');
});

document.getElementById("attendanceForm").addEventListener("submit", async (e)=>{
  e.preventDefault();

  const department = dept.value;
  const clsVal = cls.value;
  const section = sec.value;

  const { data, error } = await supabaseclient
    .from("StudentDB")
    .select("*")
    .eq("Department", department)
    .eq("Class", clsVal)
    .eq("Section", section);

  if(error || data.length === 0){
    alert("No students found");
    return;
  }

  attendanceData = data.map(s => ({...s, status:"Present", FacultyEmail:FacultyEmail}));
  renderStudents();
});

function renderStudents(){
  const container = document.getElementById("studentList");
  container.innerHTML = "";

  attendanceData.forEach((s,i)=>{
    container.innerHTML += `
      <div class="table-row">
        ${s.Rollno} - ${s.Name} - ${s.status} - 
        <button class="status-btn ${s.status==="Present"?"present":"absent"}"
          onclick="toggleStatus(${i})">
          ${s.status}
        </button>
      </div>
    `;
  });

  document.getElementById("saveBtn").style.display="inline-block";
}

function toggleStatus(i){
  attendanceData[i].status =
    attendanceData[i].status === "Present" ? "Absent" : "Present";
  renderStudents();
}

async function saveAttendance(){
  const records = attendanceData.map(s=>({
    FacultyEmail:s.FacultyEmail,
    Rollno:s.Rollno,
    Attendance:s.status
  }));

  const { error } = await supabaseclient.from("AttendanceDB").insert(records);

  if(error){
    alert("Error saving attendance");
  }else{
    alert("Attendance saved successfully");
    document.getElementById("smsBtn").style.display="inline-block";
  }
}

async function sendParentSMS() {
    const smsContainer = document.getElementById("smsLinks");
    smsContainer.innerHTML = "";

    const absentees = attendanceData.filter(s => s.status === "Absent");

    if (absentees.length === 0) {
        smsContainer.innerHTML = "<p>No absent students.</p>";
        return;
    }

    const { data: parentsData, error } = await supabaseclient
        .from("StudentDB")
        .select("ParentsPhNo")
        .in("Rollno", absentees.map(s => s.Rollno));

    if (error || !parentsData || parentsData.length === 0) {
        alert("Failed to fetch parents' phone numbers.");
        return;
    }

    const parentNumbers = parentsData.map(p => p.ParentsPhNo).join(",");

    const Faculty_Name = sessionStorage.getItem("FacultyName");
    const Professor = sessionStorage.getItem("Professor");
    const Faculty_Department = sessionStorage.getItem("FacultyDepartment");

    const message = `
Dear Parent,
This is to inform you that your child was absent for today’s class.

- ${Faculty_Name}, 
${Professor},
${Faculty_Department}, 
Kongunadu Arts and Science College (Autonomous),
GN Mills,
Coimbatore - 641029`;

    const smsLink = document.createElement("a");
    smsLink.href = `sms:${parentNumbers}?body=${encodeURIComponent(message)}`;
    smsLink.textContent = "Send SMS to all absent students' parents";
    smsLink.style.display = "block";
    smsLink.style.marginBottom = "10px";

    smsContainer.appendChild(smsLink);
}
function logout(){sessionStorage.clear(); location.href="index.html";}

</script>

</body>
</html>

